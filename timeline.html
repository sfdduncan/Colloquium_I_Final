<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cyberfeminism Timeline</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html,body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      overflow-x: hidden;
      overflow-y: hidden;
      display: block;
    }

    body {
  display: flex;
  flex-direction: column;
}
  

    #explanation h1 {
      margin: 0 0 10px 0;
      font-size: 1.5em;
    }

    #explanation p {
      font-size: 0.95em;
    }

#timeline-container {
  margin: 0;
  padding-bottom: 20px;
  padding-top: 20px;
  max-width: 1200px;
  display: grid;
  grid-template-columns: 100px 1fr 250px;
  grid-template-rows: 1fr;
  height: 98%;
  min-height: unset;
  width: 100%;
}


    #year-sidebar {
      grid-column: 1;
      background: white;
      border-right: 1px solid black;
      overflow: hidden;
      height: 100%;
    }

    #year-timeline {
  width: 100%;
  display: block;
}

    #circle-canvas-container {
      grid-column: 2;
      position: relative;
      overflow: hidden;
      height: 98%;
      width: 100%;
      display: block;
    }

    #circle-canvas {
      display: block;
      width: 100%;
      height: 99%;
      margin-bottom: 20px;
    }

    #bar-chart {
      grid-column: 3;
      background: white;
      border-left: 1px solid black;
      overflow: hidden;
      height: 100%;
        min-width: 220px;   
    }

#bar-chart-svg {
  width: 100%;
  height: 100%;
  display: block;
}

#circle-canvas, #year-timeline {
  width: 100%;
  height: 99%;
}

h1 { 
  font-size: 1em;
}

    #timeline-tooltip, #bar-tooltip {
      position: fixed;
      background: white;
      border: 1px solid black;
      padding: 10px;
      font-size: 12px;
      max-width: 300px;
      pointer-events: none;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  
  <div id="timeline-container">
    <div id="year-sidebar">
      <svg id="year-timeline"></svg>
    </div>

    <div id="circle-canvas-container">
      <canvas id="circle-canvas"></canvas>
    </div>

    <div id="bar-chart">
      <svg id="bar-chart-svg"></svg>
    </div>
     <div id="timeline-tooltip"></div>
    <div id="bar-tooltip"></div>
  </div>

  <script>
  // Canvas and context
const canvas = document.getElementById("circle-canvas");
const ctx = canvas.getContext("2d");
const container = document.getElementById("circle-canvas-container");

// Resize canvas to container
function resizeCanvas() {
  const rect = container.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
}
resizeCanvas();
window.addEventListener('resize', () => {
  resizeCanvas();
  drawYearTimeline();
  drawBarChart();
});

const tooltip = document.getElementById("timeline-tooltip");
const barTooltip = document.getElementById("bar-tooltip");

let data = [];
let circles = [];
let yearGroups = new Map();
let hoveredYear = null;

function random(min, max) {
  return Math.random() * (max - min) + min;
}

const yearColors = d3.scaleOrdinal().range([
  "#ff00ff", "#00ffff", "#ffcc00", "#ff3300", "#33cc33",
  "#6600ff", "#00ffcc", "#cc00ff", "#3399ff", "#ff6666",
  "#ccff00", "#ff0099", "#00ff00", "#0099ff", "#ff9933",
  "#ff3399", "#66ffcc", "#cc66ff", "#33ff99", "#9900cc",
  "#ffff00", "#00ccff", "#ffccff", "#ff4444", "#44ffcc"
]);

function createCirclesFromData(jsonData) {
  data = jsonData;
  jsonData.forEach(d => {
    if (!yearGroups.has(d.year)) yearGroups.set(d.year, []);
    yearGroups.get(d.year).push(d);
  });

  const years = [...yearGroups.keys()].filter(y => /^\d{4}$/.test(y)).sort();
  yearColors.domain(years);

  circles = data.map(d => ({
    x: random(20, canvas.width - 20),
    y: random(20, canvas.height - 20),
    vx: random(-0.3, 0.3),
    vy: random(-0.3, 0.3),
    r: 5,
    data: d,
    year: d.year,
    highlighted: false
  }));

  drawYearTimeline();
  drawBarChart();
}

function drawYearTimeline() {
  const svg = d3.select("#year-timeline");
  svg.selectAll("*").remove();

  const sidebar = document.getElementById("year-sidebar");
  const width = sidebar.clientWidth;
  const height = sidebar.clientHeight;

  const cx = width * 0.5;
  const labelX = width * 0.4;

  const years = [...yearGroups.keys()].filter(y => /^\d{4}$/.test(y)).sort();

  const yScale = d3.scalePoint()
    .domain(years)
    .range([20, height - 20]);

  svg.append("line")
    .attr("x1", cx).attr("x2", cx)
    .attr("y1", 10).attr("y2", height - 10)
    .attr("stroke", "black");

  svg.selectAll("circle")
    .data(years)
    .enter()
    .append("circle")
    .attr("cx", cx)
    .attr("cy", d => yScale(d))
    .attr("r", Math.max(6, width * 0.05))
    .attr("fill", d => (d === hoveredYear ? yearColors(d) : "white"))
    .attr("stroke", d => yearColors(d))
    .on("mouseenter", (event, year) => {
      circles.forEach(c => c.highlighted = (c.year === year));
      hoveredYear = year;
    })
    .on("mouseleave", () => {
      circles.forEach(c => c.highlighted = false);
      hoveredYear = null;
    });

  svg.selectAll("text")
    .data(years)
    .enter()
    .append("text")
    .attr("x", labelX)
    .attr("y", d => yScale(d) + 4)
    .attr("text-anchor", "end")
    .text(d => d)
    .style("font-size", `${Math.max(10, width * 0.1)}px`)
    .style("font-weight", "bold");
}

function drawBarChart() {
  const barChart = document.getElementById("bar-chart");
  const svg = d3.select("#bar-chart-svg");

  if (!barChart) return;

  const chartWidth = barChart.clientWidth;
  const chartHeight = barChart.clientHeight;


  svg.selectAll("*").remove();

  const years = [...yearGroups.keys()].filter(y => !isNaN(y)).sort();
  const yearCounts = years.map(y => ({ year: y, count: yearGroups.get(y).length }));

  const y = d3.scaleBand()
    .domain(years)
    .range([20, chartHeight - 10])
    .padding(0.2);

  const x = d3.scaleLinear()
    .domain([0, d3.max(yearCounts, d => d.count) || 1])
    .range([0, chartWidth - 70]);

  svg.selectAll("rect")
    .data(yearCounts)
    .enter()
    .append("rect")
    .attr("x", d => chartWidth - x(d.count) - 50)
    .attr("width", d => x(d.count))
    .attr("y", d => y(d.year))
    .attr("height", y.bandwidth())
    .attr("fill", "white")
    .attr("stroke", "black")
    .on("mouseenter", function(event, d) {
      d3.select(this).attr("fill", yearColors(d.year));
      barTooltip.style.display = 'block';
      barTooltip.innerText = `${d.count} entries in ${d.year}`;
      barTooltip.style.left = `${event.clientX + 10}px`;
      barTooltip.style.top = `${event.clientY + 10}px`;
      circles.forEach(c => c.highlighted = (c.year === d.year));
      hoveredYear = d.year;
    })
    .on("mouseleave", function() {
      d3.select(this).attr("fill", "white");
      barTooltip.style.display = 'none';
      circles.forEach(c => c.highlighted = false);
      hoveredYear = null;
    });

  svg.selectAll("text")
    .data(yearCounts)
    .enter()
    .append("text")
    .attr("x", chartWidth - 10)
    .attr("y", d => y(d.year) + y.bandwidth() / 2 + 4)
    .attr("text-anchor", "end")
    .text(d => d.year)
    .style("font-size", "11px")
    .style("font-weight", "bold");
}

function drawCircles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (let c of circles) {
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
    ctx.fillStyle = c.highlighted ? yearColors(c.year) : "white";
    ctx.strokeStyle = c.highlighted ? "black" : yearColors(c.year);
    ctx.lineWidth = c.highlighted ? 1.5 : 1;
    ctx.fill();
    ctx.stroke();
  }
}

function updatePositions() {
  for (let c of circles) {
    c.x += c.vx;
    c.y += c.vy;

    // Bounce left or right
    if (c.x - c.r <= 0 || c.x + c.r >= canvas.width) {
      c.vx *= -1;
      c.x += c.vx;
    }

    // Bounce top or bottom
    if (c.y - c.r <= 0 || c.y + c.r >= canvas.height) {
      c.vy *= -1;
      c.y += c.vy;
    }
  }
}



function detectHover(mx, my) {
  hoveredYear = null;
  for (let c of circles) {
    const dist = Math.hypot(mx - c.x, my - c.y);
    if (dist < c.r + 5) {
      hoveredYear = c.year;
      tooltip.style.display = 'block';
      tooltip.innerHTML = `
        <strong>${c.data.project || 'Untitled'}</strong><br>
        <em>${(c.data.authors || []).join(', ')}</em><br>
        <small>${c.data.year}</small><br><br>
        ${c.data.excerpt || ''}
      `;
      const rect = canvas.getBoundingClientRect();
      tooltip.style.left = `${rect.left + c.x + 12}px`;
      tooltip.style.top = `${rect.top + c.y + 12}px`;
      return;
    }
  }
  tooltip.style.display = 'none';
}

function updateTimelineHighlights() {
  d3.selectAll("#year-timeline circle")
    .attr("fill", d => (d === hoveredYear ? yearColors(d) : "white"));
}

function animate() {
  updatePositions();
  drawCircles();
  updateTimelineHighlights();
  requestAnimationFrame(animate);
}

canvas.addEventListener("mousemove", (e) => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  detectHover(x, y);
  circles.forEach(c => c.highlighted = (c.year === hoveredYear));
});

// Load data
fetch("cyberfeminism_manifesto_refs.json")
  .then(res => {
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    return res.json();
  })
  .then(json => {
    createCirclesFromData(json);
    animate();
  })
  .catch(error => {
    console.error('Error loading data:', error);
  });

  </script>
</body>
</html>